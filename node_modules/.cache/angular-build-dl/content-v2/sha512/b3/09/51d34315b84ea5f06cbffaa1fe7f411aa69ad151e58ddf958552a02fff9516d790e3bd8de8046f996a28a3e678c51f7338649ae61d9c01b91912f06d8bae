{"version":3,"sources":["./src/app/pages/home/wellbeing/agenda/videocall/videocall.module.ts","./src/app/pages/home/wellbeing/agenda/videocall/videocall.page.ts","./src/app/pages/home/wellbeing/agenda/videocall/videocall-routing.module.ts","./src/app/pages/home/wellbeing/agenda/videocall/videocall.page.scss","./src/app/pages/home/wellbeing/agenda/videocall/videocall.page.html"],"names":[],"mappings":"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","file":"videocall-videocall-module-es2015.js","sourcesContent":["import { NgModule } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\n\nimport { IonicModule } from '@ionic/angular';\nimport { TranslateModule } from '@ngx-translate/core';\nimport { VideocallPageRoutingModule } from './videocall-routing.module';\n\nimport { VideocallPage } from './videocall.page';\nimport { ComponentsModule } from 'src/app/components/components.module';\n\n@NgModule({\n  imports: [\n    CommonModule,\n    FormsModule,\n    IonicModule,\n    VideocallPageRoutingModule,\n    TranslateModule,\n    ComponentsModule\n  ],\n  declarations: [VideocallPage]\n})\nexport class VideocallPageModule {}\n","import {Component, OnDestroy, OnInit} from '@angular/core';\nimport {ActivatedRoute} from \"@angular/router\";\nimport {AuthenticationService} from \"../../../../../services/authentication.service\";\nimport {LoadingController} from \"@ionic/angular\";\nimport {HttpErrorResponse} from \"@angular/common/http\";\nimport { AppointmentService } from 'src/app/services/appointment.service';\nimport { Agenda, IAgenda, TeladocCredentials, TeladocUser } from 'src/app/shared/classes/appointments';\nimport { Plugins } from '@capacitor/core';\nimport { TranslateService } from '@ngx-translate/core';\n\ndeclare let OT: any;\nconst { TeladocPlugin } = Plugins;\n@Component({\n  selector: 'app-videocall',\n  templateUrl: './videocall.page.html',\n  styleUrls: ['./videocall.page.scss'],\n})\n\n\n\nexport class VideocallPage implements OnInit, OnDestroy {\n\n  private session: any;\n  publisher: any;\n  private idAgenda: string;\n  public agenda: IAgenda = history.state.agenda;\n  private sessionId: string;\n  private token: string;\n  private api: string;\n  public connected: boolean;\n  public connecting: boolean;\n  infoStr: string;\n  durationStr: string;\n  btnConectarStr: string;\n\n  constructor(private activatedRoute: ActivatedRoute,\n              private authService: AuthenticationService,\n              private loadingController: LoadingController,\n              private appointmentService : AppointmentService,\n              private translate: TranslateService) {\n\n    this.idAgenda = this.activatedRoute.snapshot.paramMap.get('id');\n  }\n\n  async ngOnInit() {\n    console.log(\" this.agenda: \", this.agenda);\n    this.btnConectarStr= this.translate.instant('commons.start');\n  }\n\n  ngOnDestroy(){\n    this.unpublish();\n  }\n\n  async startTeladocVideocall() {\n   \n    this.connecting = true;\n    this.btnConectarStr = \"Conectando...\";\n   \n    this.appointmentService.getTeladocUser().subscribe(\n      async (data: TeladocUser) => {\n        this.appointmentService.teladocUser = data;\n        await this.getTeladocCredentials();\n      },(error) => {\n        // Called when error\n        error = error;\n        console.log(\"error:\", error);\n       throw error;\n      });\n    \n\n  }\n  async getTeladocCredentials(){\n  \n    this.appointmentService.getTeladocToken({client_code:this.appointmentService.teladocUser.client_code, project_id:this.appointmentService.teladocUser.project_id}).subscribe(\n      async (data: TeladocCredentials) => {\n\n        console.log(\"getTeladocCredentials: \",  this.appointmentService.teladocCredentials);\n        this.appointmentService.teladocCredentials = data;\n        this.appointmentService.startTeladocVideocall(parseInt(this.idAgenda), parseInt(this.appointmentService.teladocUser.project_id)).subscribe(\n          async (res) => {\n            if(res.status=='150')\n              this.appointmentService.showAlert('Encara no té doctor assignat');\n            else if(res.data){\n              const videoDetailsJSONString = JSON.stringify(res.data); //JSON.stringify({videoDetailsJSONString:res.data});\n              TeladocPlugin.makeVideoCall({videoDetailsJSONString:videoDetailsJSONString});\n              this.connecting = false;\n              this.btnConectarStr = this.translate.instant('commons.start');\n            }else\n              this.appointmentService.showAlert(\"No s'ha pogut iniciar la sessió\");\n           \n          }, (error) =>{\n            console.log(\"error\", error);\n           throw error;\n          });\n        \n      },(error) => {\n       throw error;\n      });\n    \n  }\n\n  async startVideocall() {\n\n    if(this.agenda?.agenda_type_id == 6){\n      this.idAgenda = this.agenda?.ext_id;\n      this.startTeladocVideocall();\n    }else\n      this.startDooleVideocall();\n    \n  }\n\n  async startDooleVideocall(){\n    this.connecting = true;\n    this.btnConectarStr = \"Conectando...\";\n\n    const loading = await this.loadingController.create();\n    await loading.present();\n\n    this.authService.get('user/agenda/' + this.idAgenda + '/videocallSession').subscribe(\n        async (data) => {\n          let response = data;\n          this.sessionId = response.sessionId;\n          this.token = response.token;\n          this.api = response.tokboxAPI;\n\n          this.session = OT.initSession(this.api, this.sessionId);\n          this.publisher = OT.initPublisher('publisher', {fitMode: \"contain\"}, (error) => {\n            if (error) {\n              console.log(error);\n              return;\n            }\n          });\n\n          /*this.insomnia.keepAwake()\n              .then(\n                  () => console.log('success'),\n                  () => console.log('error')\n              );*/\n\n          this.session.on({\n            streamCreated: (event) => {\n              var subscriberOptions = {fitMode: \"contain\", insertMode: 'append'};\n              this.session.subscribe(event.stream, 'subscriber', subscriberOptions);\n              OT.updateViews();\n            },\n            streamDestroyed: (event) => {\n              console.log(`Stream ${event.stream.name} ended because ${event.reason}`);\n              OT.updateViews();\n            },\n            sessionConnected: event => {\n              this.connected = true;\n              this.session.publish(this.publisher);\n              OT.updateViews();\n            },\n            connectionCreated: (event) => {\n              if (event.connection.connectionId != this.session.connection.connectionId) {\n                //this.showMessage(\"Se ha conectado un usuario\");\n                this.infoStr = \"\";\n              } else {\n\n              }\n            },\n          });\n\n          this.session.on(\"signal:duration\", (event) => {\n            if (event.data > 60) {\n              var min = event.data / 60;\n              min = Math.floor(min);\n              this.durationStr = \"Unos \" + Math.round(min) + \" minutos\";\n            } else if (event.data > 0) {\n              this.durationStr = \"Menos de 1 minuto\";\n            } else {\n              this.durationStr = \"Tiempo agotado\";\n            }\n\n          });\n\n          this.session.connect(this.token, (error: any) => {\n            if (error) {\n              console.log(`There was an error connecting to the session ${error}`);\n            }\n          });\n        },\n        (error) => {\n          // Called when error\n          console.log(\"error: \", error);\n          throw new HttpErrorResponse(error);\n        },\n        () => {\n          // Called when operation is complete (both success and error)\n          loading.dismiss();\n        });\n  }\n\n  unpublish() {\n    this.connected=false;\n    this.connecting=false;\n    this.infoStr = \"\";\n    this.btnConectarStr = \"Conectar\";\n    if(this.session){\n      this.session.disconnect();\n    }\n    /*this.insomnia.allowSleepAgain()\n        .then(\n            () => console.log('success'),\n            () => console.log('error')\n        );*/\n  }\n\n}\n","import { NgModule } from '@angular/core';\nimport { Routes, RouterModule } from '@angular/router';\n\nimport { VideocallPage } from './videocall.page';\n\nconst routes: Routes = [\n  {\n    path: '',\n    component: VideocallPage\n  }\n];\n\n@NgModule({\n  imports: [RouterModule.forChild(routes)],\n  exports: [RouterModule],\n})\nexport class VideocallPageRoutingModule {}\n","export default \"\\n/*# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IiIsImZpbGUiOiJ2aWRlb2NhbGwucGFnZS5zY3NzIn0= */\";","export default \"<custom-header></custom-header>\\n<ion-content>\\n  <div id=\\\"publisher\\\"></div>\\n  <div id=\\\"subscriber\\\"></div>\\n  <div id=\\\"infoText\\\">{{infoStr}}</div>\\n  <div *ngIf=\\\"connected\\\" id=\\\"duration\\\"><i class=\\\"fas fa-clock\\\"></i> {{durationStr}}</div>\\n  <ion-button expand=\\\"block\\\" *ngIf=\\\"!connected\\\" ion-button icon-left id=\\\"btnConectar\\\"(click)=\\\"startVideocall()\\\" [disabled]=\\\"connecting\\\"><ion-icon name=\\\"videocam\\\"style=\\\"zoom:1;\\\" slot=\\\"end\\\"></ion-icon>{{btnConectarStr}} </ion-button>\\n  <div id=\\\"actionDiv\\\">\\n    <button *ngIf=\\\"connected\\\" ion-button id=\\\"btnColgar\\\" (click)=\\\"unpublish()\\\">{{ 'commons.end' | translate }}</button>\\n    <div *ngIf=\\\"connected\\\" id=\\\"duration\\\"><i class=\\\"fas fa-clock\\\"></i> {{durationStr}}</div>\\n  </div>\\n</ion-content>\\n\";"],"sourceRoot":"webpack:///"}